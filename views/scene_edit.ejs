<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- <link href="/css/grid.css" rel="stylesheet"> -->
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/popper.min.js"></script>

    <title>编辑场景-
        <%=scene.SceneName%>
    </title>
</head>

<body>
    <div class="container">

        <h1 id="test">编辑场景</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/scene/admin">场景</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <%=scene.SceneName%>
                </li>
            </ol>
        </nav>




        <hr/>
        <h2>基础信息</h2>
        <form class="needs-validation" novalidate="">

            <div class="mb-3">
                <label for="username">场景名称</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="scenename" name="scenename" placeholder="场景名称" value="<%=scene.SceneName%>" required="">
                    <div class="invalid-feedback" style="width: 100%;">
                        必须填写场景名称.
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="address">场景描述</label>
                <textarea type="text" class="form-control" id="description" name="description" placeholder="场景描述" rows=5 required="">
                    <%=scene.Description%>
                </textarea>
                <div class="invalid-feedback">
                    必须填写场景描述.
                </div>
            </div>

            <div class="mb-3">
                <label>创建时间(只读)</label>
                <input class="form-control" type="text" id="createTime" value="<%=scene.CreateTime%>" readonly>
            </div>
            <div class="mb-3">
                <label>修改时间(只读)</label>
                <input class="form-control" type="text" id="updateTime" value="<%=scene.UpdateTime%>" readonly>
            </div>

            <div class="mb-3">
                <label>提示语音(填写音频文件名称)</label>
                <input class="form-control" type="text" id="beginAudio" value="<%=scene.BeginAudio%>">
            </div>
            <button id="submitBasicInfo" type="button" class="btn btn-primary btn-lg btn-block">提交基础信息</button>
        </form>



        <hr/>
        <h2>准备阶段信息</h2>
        <form class="needs-validation" novalidate="">
            <div class="mb-3">
                <label>时间限定(单位:秒)</label>
                <input class="form-control" id="prepare_timeLimit" type="text" value="<%=scene.Preparation.TimeLimit%>">
            </div>
            <div class="mb-3">
                <label>分值权重</label>
                <input class="form-control" id="prepare_score" type="text" value="<%=scene.Preparation.ScoreWeight%>">
            </div>

            <h3 name="actions">涉及到的操作</h3>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="addActionInvolved" placeholder="新增操作" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" id="addActionInvolvedButton" type="button" onclick="AddAction()">添加</button>
                </div>
            </div>
            <ul class="list-group" id="actionsInvolved">

            </ul>

            <button id="SubmitPreparation" type="button" class="btn btn-primary btn-lg btn-block">提交准备阶段信息</button>
        </form>




        <hr/>
        <h2>场景流程信息</h2>
        <form class="needs-validation" novalidate="">
            <!-- 新增场景按钮 -->
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="输入该流程的指令，用于代表该流程" aria-label="Recipient's username" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button">新增流程</button>
                </div>
            </div>
            <!-- 流程开始 -->
            <div class="accordion" id="accordion">
                
                <div class="card">
                    <div class="card-header" id="heading1">
                        <h5 class="mb-0">
                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="false" aria-controls="collapse1">
                                指令1
                            </button>
                        </h5>
                    </div>

                    <div id="collapse1" class="collapse" aria-labelledby="heading1" data-parent="#accordion">
                        <div class="card-body">
 
                            <div class="mb-3">
                                <label>分值权重</label>
                                <input class="form-control" id="tf_scoreweight" type="text" value="<%=scene.TaskFlow.ScoreWeight%>">
                            </div>

                            <div class="mb-3">
                                <label>指令</label>
                                <input class="form-control" id="tf_order" type="text" value="<%=scene.TaskFlow.Order%>">
                            </div>

                            <div class="mb-3">
                                <label>指令音频</label>
                                <input class="form-control" id="tf_orderaudio" type="text" value="<%=scene.TaskFlow.OrderAudio%>">
                            </div>

                            <div class="mb-3">
                                <label>汇报</label>
                                <input class="form-control" id="tf_report" type="text" value="<%=scene.TaskFlow.Report%>">
                            </div>

                            <div class="mb-3">
                                <label>时间限定(秒)</label>
                                <input class="form-control" id="tf_timelimit" type="text" value="<%=scene.TaskFlow.TimeLimit%>">
                            </div>

                            <div class="mb-3">
                                <label>新增条件</label>

                                <div class="form-row">
                                    <div class="form-group col-md-5">
                                        <label for="inputState">条件类型</label>
                                        <select class="form-control" id="exampleFormControlSelect1">
                                            <option>1</option>
                                            <option>2</option>
                                            <option>3</option>
                                            <option>4</option>
                                            <option>5</option>
                                        </select>
                                    </div>
                                    <div class="form-group col-md-5">
                                        <label for="inputCity">对象ID</label>
                                        <input type="text" class="form-control" id="inputCity">
                                    </div>
                                    <div class="form-group col-md-2">
                                        <label for="inputCity">操作</label>
                                        <button type="button" class="btn btn-success form-control">添加条件</button>
                                    </div>
                                </div>
                                <label>条件列表</label>
                                <div class="form-row">
                                    <div class="col-md-5">
                                        <select class="form-control" id="exampleFormControlSelect1">
                                            <option>1</option>
                                            <option>2</option>
                                            <option>3</option>
                                            <option>4</option>
                                            <option>5</option>
                                        </select>
                                    </div>
                                    <div class=" col-md-5">
                                        <input type="text" class="form-control" id="inputCity">
                                    </div>
                                    <div class=" col-md-2">

                                        <button type="button" class="btn btn-danger form-control">删除</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="heading2">
                        <h5 class="mb-0">
                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse2" aria-expanded="false"
                                aria-controls="collapse2">
                                指令2
                            </button>
                        </h5>
                    </div>
                    <div id="collapse2" class="collapse" aria-labelledby="heading2" data-parent="#accordion">
                        <div class="card-body">
                            Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute,
                            non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf
                            moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch
                            et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                            Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic
                            synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="heading3">
                        <h5 class="mb-0">
                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapse3" aria-expanded="false"
                                aria-controls="collapse3">
                                指令3
                            </button>
                        </h5>
                    </div>
                    <div id="collapse3" class="collapse" aria-labelledby="heading3" data-parent="#accordion">
                        <div class="card-body">
                            Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute,
                            non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf
                            moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla assumenda shoreditch
                            et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.
                            Ad vegan excepteur butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim aesthetic
                            synth nesciunt you probably haven't heard of them accusamus labore sustainable VHS.
                        </div>
                    </div>
                </div>
            </div>
            <!-- 流程结束 -->


            <button id="SubmitTaskFlow" type="button" class="btn btn-primary btn-lg btn-block">提交流程信息</button>
        </form>


    </div>


    </div>
    <!-- /container -->

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">信息</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    操作成功！
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="sceneID" id="sceneID" value="<%=scene._id%>">

    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/lodash.js"></script>

    <script>
        var sceneID = $("#sceneID").val();

        $(document).ready(function () {
            $("#submitBasicInfo").click(function () {
                SubmitBasicInfo(sceneID);
            });
            $("#SubmitPreparation").click(function () {
                SubmitPreparation(sceneID);
            });
            $("#SubmitTaskFlow").click(function () {

            });
        });

        //提交基本信息
        function SubmitBasicInfo(id) {
            var sceneName = $("#scenename").val();
            var des = $("#description").val();
            var beginaudio = $("#beginAudio").val();
            $.ajax({
                url: "/scene/" + id,
                type: "PUT",
                dataType: "text",
                data: JSON.stringify({
                    "SceneName": sceneName,
                    "Description": des,
                    "BeginAudio": beginaudio
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (res, status) {
                    $("#exampleModal").modal('show');
                }
            });
        };

        //刷新涉及到的操作
        function RefreshActionsInvoled(id) {
            $.get("/scene/" + id, function (result) {

                //防止和后端模板冲突
                _.templateSettings.interpolate = /{{([\s\S]+?)}}/g;

                var actions = result.Preparation.ActionsInvolved;
                var compiled = _.template(
                    '<li class="list-group-item"><a href="#actions" onclick="DeleteAction(this)" class="badge badge-danger">X</a>&nbsp;&nbsp;<span>{{item}}</span></li>'
                );

                //先清空
                $("#actionsInvolved").html("");

                //再逐个添加
                for (let i = 0; i < actions.length; i++) {
                    $("#actionsInvolved").append(
                        compiled({
                            'item': actions[i]
                        })
                    );
                }
            });
        };

        //初始化涉及到的操作
        RefreshActionsInvoled(sceneID);

        //增加一个涉及到的操作
        function AddAction() {
            var newActionStr = $("#addActionInvolved").val();
            var item =
                '<li class="list-group-item"><a href="#actions" onclick="DeleteAction(this)" class="badge badge-danger">X</a>&nbsp;&nbsp;<span>' +
                newActionStr + '</span></li>'
            $("#actionsInvolved").append(item);
            $("#addActionInvolved").val("");
        };

        //删除一个涉及到的操作(不真正提交数据库)
        function DeleteAction(item) {
            $(item).parent().remove();
        };

        //提交准备
        function SubmitPreparation(id) {
            var timeLimit = $("#prepare_timeLimit").val();
            var score = $("#prepare_score").val();
            var actions = [];

            for (let i = 0, count = $("#actionsInvolved").children().length; i < count; i++) {
                actions.push($("#actionsInvolved li:eq(" + i + ") span").html());
            }

            $.ajax({
                url: "/scene/preparation/" + id,
                type: "PUT",
                dataType: "text",
                data: JSON.stringify({
                    "TimeLimit": timeLimit,
                    "ScoreWeight": score,
                    "ActionsInvolved": actions
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                success: function (res, status) {
                    RefreshActionsInvoled(sceneID);
                    $("#exampleModal").modal('show');
                }
            })
        };

        //刷新所有流程
        function RefreshAllWorkFlow(id){
            $.get("/scene/" + id, function (result){
                //防止和后端模板冲突
                _.templateSettings.interpolate = /{{([\s\S]+?)}}/g;

                var taskflows = result.TaskFlow;

                var rawString = 
                '<div class="card" id="card{{index}}">'+
                    '<div class="card-header" id="heading{{index}}">'+
                        '<h5 class="mb-0">'+
                            '<a href="#flow{{index}}" class="badge badge-success" id="moveUp">▲</a>&nbsp;&nbsp;<a href="#flow{{index}}" class="badge badge-success" id="moveDown">▼</a>'+
                            '<button class="btn btn-link" type="button" name="flow{{index}}" data-toggle="collapse" data-target="#collapse{{index}}" aria-expanded="false" aria-controls="collapse{{index}}">'+
                                '{{taskflow.Order}}'+
                            '</button>'+
                        '</h5>'+
                    '</div>'+
                    '<div id="collapse{{index}}" class="collapse" aria-labelledby="heading{{index}}" data-parent="#accordion">'+
                        '<div class="card-body">'+
                            '<div class="mb-3">'+
                                '<label>分值权重</label>'+
                                '<input class="form-control" id="tf_scoreweight" type="text" value="{{taskflow.ScoreWeight}}">'+
                            '</div>'+
                            '<div class="mb-3">'+
                                '<label>指令</label>'+
                                '<input class="form-control" id="tf_order" type="text" value="{{taskflow.Order}}">'+
                            '</div>'+
                            '<div class="mb-3">'+
                                '<label>指令音频</label>'+
                                '<input class="form-control" id="tf_orderaudio" type="text" value="{{taskflow.OrderAudio}}">'+
                            '</div>'+
                            '<div class="mb-3">'+
                                '<label>汇报</label>'+
                                '<input class="form-control" id="tf_report" type="text" value="{{taskflow.Report}}">'+
                            '</div>'+
                            '<div class="mb-3">'+
                                '<label>时间限定(秒)</label>'+
                                '<input class="form-control" id="tf_timelimit" type="text" value="{{taskflow.TimeLimit}}">'+
                            '</div>'+
                            '<div class="mb-3">'+
                                '<label>新增条件</label>'+
                                '<div class="form-row">'+
                                    '<div class="form-group col-md-5">'+
                                        '<label for="inputState">条件类型</label>'+
                                        '<select class="form-control" id="exampleFormControlSelect1">'+
                                            '<option>检查泵的状态</option>'+
                                            '<option>确认阀门关闭</option>'+
                                            '<option>关闭阀门</option>'+
                                            '<option>开启阀门</option>'+
                                            '<option>解锁阀门</option>'+
                                            '<option>就地缓慢开启阀门</option>'+
                                            '<option>确认泵正常运行</option>'+
                                            '<option>汇报</option>'+
                                        '</select>'+
                                    '</div>'+
                                    '<div class="form-group col-md-5">'+                        
                                        '<label for="inputID">对象ID</label>'+
                                        '<input type="text" class="form-control" id="inputID">'+
                                    '</div>'+
                                    '<div class="form-group col-md-2">'+
                                        '<label for="inputID">操作</label>'+
                                        '<button type="button" class="btn btn-success form-control">添加条件</button>'+
                                    '</div>'+
                                '</div>'+
                                '<label>条件列表</label>'+
                                '<div class="form-row">'+
                                    '<div class="col-md-5">'+
                                        '<select class="form-control" id="exampleFormControlSelect1">'+
                                            '<option>检查泵的状态</option>'+
                                            '<option>确认阀门关闭</option>'+
                                            '<option>关闭阀门</option>'+
                                            '<option>开启阀门</option>'+
                                            '<option>解锁阀门</option>'+
                                            '<option>就地缓慢开启阀门</option>'+
                                            '<option>确认泵正常运行</option>'+
                                            '<option>汇报</option>'+
                                        '</select>'+
                                    '</div>'+
                                    '<div class=" col-md-5">'+
                                        '<input type="text" class="form-control" id="inputID"></input>'+
                                    '</div>'+
                                    '<div class=" col-md-2">'+
                                        '<button type="button" class="btn btn-danger form-control">删除</button>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                '</div>';
                var compiled = _.template(rawString);

                //先清空内容
                $("#accordion").html("");
                for(let i=0;i<taskflows.length;i++)
                {
                    $("#accordion").append(
                        compiled({
                            index:i,
                            taskflow:taskflows[i]
                        })
                    );
                }

            });
        };

        RefreshAllWorkFlow(sceneID);

        //添加流程
        function AddWorkFlow(order) {

           // $("#accordion").append("")
        };

        //提交流程
        function SubmitTaskFlow(id) {
            var scoreWeight = $("#tf_scoreweight").val();
            var order = $("#tf_order").val();
            var orderAudio = $("#tf_orderaudio").val();
            var report = $("#tf_report").val();
            var timeLimit = $("#tf_timelimit").val();

        };





        //Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
            'use strict';

            window.addEventListener('load', function () {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');

                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('click', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>
</body>

</html>